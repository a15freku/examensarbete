<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>SVG Diagram</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="text/javascript" src="../Data/data.js"></script>
  <script type="text/javascript" src="../Data/randomSeed.js"></script>
  <style>
    #svgContainer {
      width: 1250px;
      height: 300px;
      background-color: white;
      border: solid;
      border-color: black;

    }
  </style>
  <script>

    // Retrive JSON object from data.js
    var data = stockObj.data;
    //data=[data[0],data[1]];
	  var orgDataLen=data.length;

    // Creates more data from existing data
    function applyOffset(input) {
      // Set how many graphs should be used
      for(var i = 0; i < 200; i++) {
        // Create more data
        var src = input[i%orgDataLen];
        var o = new Object();
        o.name = src.name+i;
        o.value = [];
        input[orgDataLen+i] = o;
        // Apply Offset
        for(var j = 0; j < 251; j++) {

          var max = 1.01;
          var min = 0.99;
          var r = Math.random() * (max - min) + min;
          o.value[j] = src.value[j] * r;
        }
      }
    // Return offsetData
    return input;
    }

    // New Normalize data function
    function normalize(input){
      for(var i = 0; i < input.length; i++) {

        var length = input[i].value.length;
        var min = input[i].value[0];
        var max = min;
  
        for(var j = 1; j < length; j++) {
  
          var val = input[i].value[j];
          min = Math.min(min, val);
          max = Math.max(max, val);

        }
        var range = max - min;

        var normArray = [];
        for(var k = 0; k < length; k++) {

          normArray.push((input[i].value[k] - min) / range);
          
        }
        input[i].value = normArray;
      }

      return input;
    }

    // Normalized data
    data = applyOffset(data);
    data = normalize(data);

    // Change opacity from 100% to 0%,
    function modifyGraph() {

      var svgElement = document.getElementById("diagram"); // get the parent node
      var polylines = svgElement.getElementsByTagName('polyline'); // get child nodes 
      var polyLength = polylines.length;

      var startDate = new Date();
      // Change opacity
      for(var i = 10; i >= 0; i--) {
        for (var j = 0; j < polyLength; j++)
        {
          polylines[j].setAttribute("opacity", i/10);
        }
      }
      var endDate = new Date();
      var milliseconds = (endDate.getTime() - startDate.getTime());
      console.log("ms: " + milliseconds);

      // Reset opacity
      for (var k = 0; k < polyLength; k++)
      { 
        polylines[k].setAttribute("opacity", 1);
      }
      
    }

    // Returns data in string (attr points)
    function polyData(index) {
      var poly = "";
      for(var i = 0; i < 251; i++) {
        poly += (i * 5) + "," + data[index].value[i] * 300 + " ";
      }

      return poly;
    }

    // Draw lines in graph
    function drawGraph(polyline, polyData) {
      polyline.setAttributeNS(null, 'stroke', "green");
      polyline.setAttributeNS(null, 'stroke-width', 1);
      polyline.setAttributeNS(null, 'points', polyData);
      polyline.setAttributeNS(null, 'fill', "none");
      //polyline.setAttributeNS(null, 'opacity', 1.0);

      return polyline;
    }

    function createSVG() {
      var xmlns = "http://www.w3.org/2000/svg";

      // Set height and width
      var boxWidth = 1250;
      var boxHeight = 300;
      
      // Create SVG root element
      var svgElem = document.createElementNS(xmlns, "svg");
      svgElem.setAttributeNS(null, "viewBox", "0 0 " + boxWidth + " " + boxHeight);
      svgElem.setAttributeNS(null, "width", boxWidth);
      svgElem.setAttributeNS(null, "height", boxHeight);

      // Create group element
      var g = document.createElementNS(xmlns, "g");
      g.setAttributeNS(null, 'transform', 'matrix(1,0,0,-1,0,300)');
      g.setAttributeNS(null, 'id', 'diagram');
      svgElem.appendChild(g);
      
      /*
      // Draw borders
      var coords = "0,0 0,300 1250,300 1250,0 0,0";
      var path = document.createElementNS (xmlns, "polyline");
      path.setAttributeNS(null, 'stroke', "black");
      path.setAttributeNS(null, 'stroke-width', 1);
      path.setAttributeNS(null, 'points', coords);
      path.setAttributeNS(null, 'fill', "none");
      path.setAttributeNS(null, 'opacity', 1.0);
      g.appendChild(path);
      */

      // Draw lines in graph
      var polyline;
      for(var i = 0; i < data.length; i++) {
        polyline = document.createElementNS(xmlns, "polyline");
        g.appendChild(drawGraph(polyline, polyData(i)));
      }

      // Add SVG element to div-container
      var svgContainer = document.getElementById("svgContainer");
      svgContainer.appendChild(svgElem);
    }

    // Information
    function info() {
      console.log("Total Polylines: " + data.length);
    }

    // Test
    function testFunction() {
  
      for(var i = 0; i < 20; i++ ){
        console.log("--- Test " + i + " ---");
        modifyGraph();
      }
    }
   // testFunction();

  </script>
</head>

<body onload="createSVG()">
  <div id="svgContainer"></div>
</body>

</html>